<section
  id="{{ widget.id }}"
  class="widget widget-countdown widget-{{ widget.id }} color-scheme-{{ widget.settings.color_scheme }}"
  {% if widget.settings.color_scheme == 'dark' %}
    style="--widget-bg-color: var(--bg-primary);"
  {% endif %}
  data-widget-id="{{ widget.id }}"
  data-widget-type="countdown"
  {% if widget.index != null %}data-widget-index="{{ widget.index }}"{% endif %}
>
  <style>
    .widget-{{ widget.id }} {
      & .countdown-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      & .countdown-timer {
        display: flex;
        justify-content: center;
        gap: var(--space-md);
      }

      & .countdown-unit {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 80px;
      }

      /* Cards style */
      & .style-cards .countdown-unit {
        background: var(--bg-primary);
        border: var(--border-width-thin) solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: var(--space-lg);
      }

      & .countdown-number {
        font-size: var(--font-size-4xl);
        line-height: 1;
        font-variant-numeric: tabular-nums;
        color: var(--text-heading);
      }

      /* Minimal style */
      &.style-minimal .countdown-unit {
        min-width: auto;
      }

      &.style-minimal .countdown-number {
        font-size: var(--font-size-5xl);
      }

      &.style-minimal .countdown-separator {
        align-self: flex-start;
        padding-block-start: var(--space-md);
      }

      & .countdown-expired {
        margin-block: var(--space-xl);
      }

      & .countdown-button {
        margin-block-start: var(--space-md);
      }

      @media (max-width: 600px) {
        & .countdown-timer {
          gap: var(--space-sm);
        }

        & .countdown-unit {
          min-width: 60px;
        }

        &.style-cards .countdown-unit {
          padding: var(--space-md);
        }

        & .countdown-number {
          font-size: var(--font-size-2xl);
        }

        &.style-minimal .countdown-number {
          font-size: var(--font-size-3xl);
        }
      }
    }
  </style>

  <div class="widget-container {% if widget.settings.color_scheme == 'dark' %}widget-container-padded{% endif %}">
    {% if widget.settings.title != blank or widget.settings.description != blank or widget.settings.eyebrow != blank %}
      <div class="widget-header">
        {% if widget.settings.eyebrow != blank %}
          <span class="widget-eyebrow" data-setting="eyebrow">{{ widget.settings.eyebrow }}</span>
        {% endif %}
        {% if widget.settings.title != blank %}
          <h2 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h2>
        {% endif %}
        {% if widget.settings.description != blank %}
          <p class="widget-description" data-setting="description">{{ widget.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="widget-content style-{{ widget.settings.style }}">
      <div class="countdown-container">
        <div
          class="countdown-timer"
          data-target="{{ widget.settings.target_date }}"
          data-expired-message="{{ widget.settings.expired_message }}"
          data-show-seconds="{{ widget.settings.show_seconds }}"
          data-style="{{ widget.settings.style }}"
        >
          <div class="countdown-unit">
            <span class="countdown-number" data-unit="days">00</span>
            <span class="countdown-label block-text block-text-sm block-text-muted block-text-uppercase">Days</span>
          </div>
          {% if widget.settings.style == 'minimal' -%}
            <span class="countdown-separator block-text block-text-4xl block-text-muted">:</span>
          {%- endif %}
          <div class="countdown-unit">
            <span class="countdown-number" data-unit="hours">00</span>
            <span class="countdown-label block-text block-text-sm block-text-muted block-text-uppercase">Hours</span>
          </div>
          {% if widget.settings.style == 'minimal' -%}
            <span class="countdown-separator block-text block-text-4xl block-text-muted">:</span>
          {%- endif %}
          <div class="countdown-unit">
            <span class="countdown-number" data-unit="minutes">00</span>
            <span class="countdown-label block-text block-text-sm block-text-muted block-text-uppercase">Minutes</span>
          </div>
          {% if widget.settings.show_seconds %}
            {% if widget.settings.style == 'minimal' -%}
              <span class="countdown-separator block-text block-text-4xl block-text-muted">:</span>
            {%- endif %}
            <div class="countdown-unit">
              <span class="countdown-number" data-unit="seconds">00</span>
              <span class="countdown-label block-text block-text-sm block-text-muted block-text-uppercase">Seconds</span>
            </div>
          {% endif %}
        </div>

        {% if widget.settings.button.text != blank %}
          <div class="countdown-button">
            <a
              href="{{ widget.settings.button.href }}"
              class="widget-button"
              data-setting="button"
              {% if widget.settings.button.target == '_blank' %}
                target="_blank" rel="noopener"
              {% endif %}
            >
              {{ widget.settings.button.text }}
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    (function () {
      const widget = document.getElementById('{{ widget.id }}');
      if (!widget || widget.dataset.initialized) return;
      widget.dataset.initialized = 'true';

      const timer = widget.querySelector('.countdown-timer');
      if (!timer) return;

      const targetDate = new Date(timer.dataset.target).getTime();
      const expiredMessage = timer.dataset.expiredMessage;
      const showSeconds = timer.dataset.showSeconds === 'true';

      function updateCountdown() {
        const now = new Date().getTime();
        const distance = targetDate - now;

        if (distance < 0) {
          timer.innerHTML = '<div class="countdown-expired block-text block-text-2xl block-text-accent">' + expiredMessage + '</div>';
          return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        const daysEl = timer.querySelector('[data-unit="days"]');
        const hoursEl = timer.querySelector('[data-unit="hours"]');
        const minutesEl = timer.querySelector('[data-unit="minutes"]');
        const secondsEl = timer.querySelector('[data-unit="seconds"]');

        if (daysEl) daysEl.textContent = String(days).padStart(2, '0');
        if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
        if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
        if (secondsEl) secondsEl.textContent = String(seconds).padStart(2, '0');
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);
    })();
  </script>
</section>
