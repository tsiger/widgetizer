<section
  id="{{ widget.id }}"
  class="widget widget-type-gallery widget-{{ widget.id }} color-scheme-{{ widget.settings.color_scheme }}"
  {% if widget.settings.color_scheme == 'highlight' %}
    style="--widget-bg-color: var(--bg-primary);"
  {% endif %}
  data-widget-id="{{ widget.id }}"
  data-widget-type="gallery"
  {% if widget.index != null %}data-widget-index="{{ widget.index }}"{% endif %}
>
  <style>
    .widget-{{ widget.id }} {
      & .widget-card {
        position: relative;
        overflow: hidden;
        {% if widget.settings.aspect_ratio != 'auto' and widget.settings.aspect_ratio != 'contain' %}
          aspect-ratio: {{ widget.settings.aspect_ratio | default: '4 / 3' }};
        {% endif %}
        cursor: pointer;
        padding: 0;

        &:hover {
          & .widget-card-image {
            transform: scale(1.05);
          }
          & .gallery-overlay {
            opacity: 1;
          }
        }
      }

      & .widget-card-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.3s;
        aspect-ratio: auto;
        margin-block-end: 0;
        border-radius: 0;
      }

      {% if widget.settings.aspect_ratio == 'contain' %}
        & .widget-card {
          aspect-ratio: auto;
        }

        & .widget-card-image {
          height: 24rem;
          max-height: 60vh;
          object-fit: contain;
        }
      {% endif %}

      & .gallery-overlay {
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: flex-end;
        padding: var(--space-md);
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }

      & .gallery-caption {
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      }

      /* Lightbox Styles */
      & .gallery-modal {
        position: fixed;
        inset: 0;
        background-color: var(--bg-primary);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;

        &.is-open {
          opacity: 1;
          visibility: visible;
        }
      }

      & .gallery-modal-content {
        width: fit-content;
        max-width: 90%;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      & .gallery-modal-close {
        position: absolute;
        inset-block-start: -3.75rem;
        inset-inline-end: -0.25rem;
        width: 3rem;
        height: 3rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.95);
        border: 1px solid var(--border-color);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
        cursor: pointer;
        color: var(--text-heading);
        padding: var(--space-xs);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;

        & svg {
          width: 1.75rem;
          height: 1.75rem;
        }

        &:hover {
          transform: scale(1.05);
          background-color: #fff;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.22);
        }

        &:focus-visible {
          outline: 2px solid #fff;
          outline-offset: 2px;
        }
      }

      & .gallery-modal-nav {
        position: absolute;
        inset-block-start: 50%;
        transform: translateY(-50%);
        width: 3rem;
        height: 3rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.9);
        border: 1px solid var(--border-color);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
        color: var(--text-heading);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;

        & svg {
          width: 1.5rem;
          height: 1.5rem;
        }

        &:hover {
          transform: translateY(-50%) scale(1.05);
          background-color: #fff;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.22);
        }

        &:focus-visible {
          outline: 2px solid var(--text-heading);
          outline-offset: 2px;
        }

        &:disabled {
          opacity: 0.45;
          cursor: not-allowed;
          box-shadow: none;
        }
      }

      & .gallery-modal-nav.is-prev {
        inset-inline-start: -3.75rem;
      }

      & .gallery-modal-nav.is-next {
        inset-inline-end: -3.75rem;
      }

      & .gallery-modal-image {
        width: auto;
        max-height: 80vh;
        max-width: 90vw;
        object-fit: contain;
        display: block;
        margin-inline: auto;
        border: var(--border-width-thin) solid var(--border-color);
      }

      & .gallery-modal-caption {
        text-align: center;
        padding-block-start: var(--space-md);
        color: var(--text-muted);
      }
    }
  </style>

  <div class="widget-container {% if widget.settings.color_scheme == 'highlight' %}widget-container-padded{% endif %}">
    {% if widget.settings.title != blank or widget.settings.description != blank or widget.settings.eyebrow != blank %}
      <div class="widget-header">
        {% assign header_delay = 0 %}
        {% if widget.settings.eyebrow != blank %}
          <span class="widget-eyebrow reveal reveal-up" style="--reveal-delay: {{ header_delay }}" data-setting="eyebrow">{{ widget.settings.eyebrow }}</span>
          {% assign header_delay = header_delay | plus: 1 %}
        {% endif %}
        {% if widget.settings.title != blank %}
          {% if widget.index == 1 %}
            <h1 class="widget-headline reveal reveal-up" style="--reveal-delay: {{ header_delay }}" data-setting="title">{{ widget.settings.title }}</h1>
          {% else %}
            <h2 class="widget-headline reveal reveal-up" style="--reveal-delay: {{ header_delay }}" data-setting="title">{{ widget.settings.title }}</h2>
          {% endif %}
          {% assign header_delay = header_delay | plus: 1 %}
        {% endif %}
        {% if widget.settings.description != blank %}
          <p class="widget-description reveal reveal-up" style="--reveal-delay: {{ header_delay }}" data-setting="description">{{ widget.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="widget-content">
      <ul
        class="widget-card-grid widget-grid"
        style="--grid-cols-desktop: {{ widget.settings.columns_desktop }};"
      >
        {% for blockId in widget.blocksOrder %}
          {% assign block = widget.blocks[blockId] %}
          <li
            class="widget-card reveal reveal-scale"
            style="--reveal-delay: {{ forloop.index0 }}"
            data-block-id="{{ blockId }}"
            data-caption="{{ block.settings.caption }}"
          >
            {% if block.settings.image != blank %}
              {{ block.settings.image | image: 'medium', 'widget-card-image' }}
            {% else %}
              {% placeholder_image 'landscape', { "class": "widget-card-image" } %}
            {% endif %}
            {% if block.settings.caption != blank %}
              <div class="gallery-overlay">
                <span class="gallery-caption block-text block-text-sm" data-setting="caption">{{ block.settings.caption }}</span>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Lightbox Modal -->
    <div
      class="gallery-modal"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
      aria-label="Image preview"
      aria-describedby="gallery-modal-caption-{{ widget.id }}"
    >
      <div class="gallery-modal-content">
        <button class="gallery-modal-nav is-prev" aria-label="Previous image" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <button class="gallery-modal-close" aria-label="Close lightbox">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <button class="gallery-modal-nav is-next" aria-label="Next image" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <img class="gallery-modal-image" src="" alt="">
        <p class="gallery-modal-caption" id="gallery-modal-caption-{{ widget.id }}"></p>
      </div>
    </div>
  </div>

  <script>
    (function() {
      setTimeout(function() {
        const widget = document.getElementById('{{ widget.id }}');
        if (!widget || widget.dataset.initialized) return;
        widget.dataset.initialized = 'true';

        const modal = widget.querySelector('.gallery-modal');
        const modalImage = widget.querySelector('.gallery-modal-image');
        const modalCaption = widget.querySelector('.gallery-modal-caption');
        const closeBtn = widget.querySelector('.gallery-modal-close');
        const prevBtn = widget.querySelector('.gallery-modal-nav.is-prev');
        const nextBtn = widget.querySelector('.gallery-modal-nav.is-next');
        const galleryItems = Array.from(widget.querySelectorAll('.widget-card'));
        let lastFocusedElement = null;
        let currentIndex = 0;

        if (!modal || !modalImage) return;

        const getItemData = (index) => {
          const item = galleryItems[index];
          if (!item) return null;
          const img = item.querySelector('.widget-card-image');
          if (!img) return null;
          return {
            src: img.getAttribute('src'),
            alt: img.getAttribute('alt') || '',
            caption: item.dataset.caption || '',
          };
        };

        const updateNavState = () => {
          if (!prevBtn || !nextBtn) return;
          const hasMultiple = galleryItems.length > 1;
          prevBtn.disabled = !hasMultiple;
          nextBtn.disabled = !hasMultiple;
        };

        const renderImage = (index) => {
          const data = getItemData(index);
          if (!data) return;
          modalImage.src = data.src;
          modalImage.alt = data.alt;
          modalCaption.textContent = data.caption;
          currentIndex = index;
        };

        const openModal = (index) => {
          lastFocusedElement = document.activeElement;
          renderImage(index);
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
          closeBtn?.focus();
        };

        const closeModal = () => {
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
          if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
            lastFocusedElement.focus();
          }
        };

        galleryItems.forEach((item, index) => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const data = getItemData(index);
            if (data) openModal(index);
          });
        });

        if (closeBtn) {
          closeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal();
          });
        }

        if (prevBtn) {
          prevBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (galleryItems.length < 2) return;
            const nextIndex = (currentIndex - 1 + galleryItems.length) % galleryItems.length;
            renderImage(nextIndex);
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (galleryItems.length < 2) return;
            const nextIndex = (currentIndex + 1) % galleryItems.length;
            renderImage(nextIndex);
          });
        }

        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (!modal.classList.contains('is-open')) return;
          if (e.key === 'Escape') closeModal();
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            if (galleryItems.length < 2) return;
            const nextIndex = (currentIndex - 1 + galleryItems.length) % galleryItems.length;
            renderImage(nextIndex);
          }
          if (e.key === 'ArrowRight') {
            e.preventDefault();
            if (galleryItems.length < 2) return;
            const nextIndex = (currentIndex + 1) % galleryItems.length;
            renderImage(nextIndex);
          }
        });

        updateNavState();

        // Focus trap
        modal.addEventListener('keydown', (e) => {
          if (!modal.classList.contains('is-open') || e.key !== 'Tab') return;
          const focusable = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
          );
          if (!focusable.length) return;
          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        });
      }, 0);
    })();
  </script>
</section>
