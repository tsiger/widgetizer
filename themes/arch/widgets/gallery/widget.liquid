<section
  id="{{ widget.id }}"
  class="widget widget-type-gallery widget-{{ widget.id }} color-scheme-{{ widget.settings.color_scheme }}"
  {% if widget.settings.color_scheme == 'dark' %}
    style="--widget-bg-color: var(--bg-primary);"
  {% endif %}
  data-widget-id="{{ widget.id }}"
  data-widget-type="gallery"
  {% if widget.index != null %}data-widget-index="{{ widget.index }}"{% endif %}
>
  <style>
    .widget-{{ widget.id }} {
      & .widget-card {
        position: relative;
        overflow: hidden;
        aspect-ratio: 4 / 3;
        cursor: pointer;
        padding: 0;

        &:hover {
          & .widget-card-image {
            transform: scale(1.05);
          }
          & .gallery-overlay {
            opacity: 1;
          }
        }
      }

      & .widget-card-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.3s;
        aspect-ratio: auto;
        margin-block-end: 0;
        border-radius: 0;
      }

      & .gallery-overlay {
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: flex-end;
        padding: var(--space-md);
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }

      & .gallery-caption {
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      }

      /* Lightbox Styles */
      & .gallery-modal {
        position: fixed;
        inset: 0;
        background-color: var(--bg-primary);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;

        &.is-open {
          opacity: 1;
          visibility: visible;
        }
      }

      & .gallery-modal-content {
        max-width: var(--container-max-width);
        width: 100%;
        position: relative;
      }

      & .gallery-modal-close {
        position: absolute;
        inset-block-start: -4rem;
        inset-inline-end: 0;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-heading);
        padding: var(--space-xs);

        & svg {
          width: 3rem;
          height: 3rem;
        }
      }

      & .gallery-modal-image {
        width: 100%;
        max-height: 80vh;
        object-fit: contain;
        display: block;
        border: var(--border-width-thin) solid var(--border-color);
      }

      & .gallery-modal-caption {
        text-align: center;
        padding-block-start: var(--space-md);
        color: var(--text-muted);
      }
    }
  </style>

  <div class="widget-container {% if widget.settings.color_scheme == 'dark' %}widget-container-padded{% endif %}">
    {% if widget.settings.title != blank or widget.settings.description != blank or widget.settings.eyebrow != blank %}
      <div class="widget-header">
        {% if widget.settings.eyebrow != blank %}
          <span class="widget-eyebrow" data-setting="eyebrow">{{ widget.settings.eyebrow }}</span>
        {% endif %}
        {% if widget.settings.title != blank %}
          {% if widget.index == 1 %}
            <h1 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h1>
          {% else %}
            <h2 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h2>
          {% endif %}
        {% endif %}
        {% if widget.settings.description != blank %}
          <p class="widget-description" data-setting="description">{{ widget.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="widget-content">
      <ul
        class="widget-card-grid widget-grid"
        style="--grid-cols-desktop: {{ widget.settings.columns_desktop }};"
      >
        {% for blockId in widget.blocksOrder %}
          {% assign block = widget.blocks[blockId] %}
          <li
            class="widget-card"
            data-block-id="{{ blockId }}"
            data-caption="{{ block.settings.caption }}"
          >
            {% if block.settings.image != blank %}
              {{ block.settings.image | image: 'medium', 'widget-card-image' }}
            {% else %}
              {% placeholder_image 'landscape', { "class": "widget-card-image" } %}
            {% endif %}
            {% if block.settings.caption != blank %}
              <div class="gallery-overlay">
                <span class="gallery-caption block-text block-text-sm" data-setting="caption">{{ block.settings.caption }}</span>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Lightbox Modal -->
    <div
      class="gallery-modal"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
      aria-label="Image preview"
      aria-describedby="gallery-modal-caption-{{ widget.id }}"
    >
      <div class="gallery-modal-content">
        <button class="gallery-modal-close" aria-label="Close lightbox">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <img class="gallery-modal-image" src="" alt="">
        <p class="gallery-modal-caption" id="gallery-modal-caption-{{ widget.id }}"></p>
      </div>
    </div>
  </div>

  <script>
    (function() {
      setTimeout(function() {
        const widget = document.getElementById('{{ widget.id }}');
        if (!widget || widget.dataset.initialized) return;
        widget.dataset.initialized = 'true';

        const modal = widget.querySelector('.gallery-modal');
        const modalImage = widget.querySelector('.gallery-modal-image');
        const modalCaption = widget.querySelector('.gallery-modal-caption');
        const closeBtn = widget.querySelector('.gallery-modal-close');
        const galleryItems = widget.querySelectorAll('.widget-card');
        let lastFocusedElement = null;

        if (!modal || !modalImage) return;

        const openModal = (imageSrc, imageAlt, caption) => {
          lastFocusedElement = document.activeElement;
          modalImage.src = imageSrc;
          modalImage.alt = imageAlt || '';
          modalCaption.textContent = caption || '';
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
          closeBtn?.focus();
        };

        const closeModal = () => {
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
          if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
            lastFocusedElement.focus();
          }
        };

        galleryItems.forEach((item) => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const img = item.querySelector('.widget-card-image');
            const caption = item.dataset.caption;
            if (img) {
              const altText = img.getAttribute('alt') || '';
              openModal(img.src, altText, caption);
            }
          });
        });

        if (closeBtn) {
          closeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal();
          });
        }

        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.classList.contains('is-open')) {
            closeModal();
          }
        });

        // Focus trap
        modal.addEventListener('keydown', (e) => {
          if (!modal.classList.contains('is-open') || e.key !== 'Tab') return;
          const focusable = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
          );
          if (!focusable.length) return;
          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        });
      }, 0);
    })();
  </script>
</section>
