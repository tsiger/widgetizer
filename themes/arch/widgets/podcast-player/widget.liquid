<section
  id="{{ widget.id }}"
  class="widget widget-podcast-player widget-{{ widget.id }} color-scheme-{{ widget.settings.color_scheme }}"
  {% if widget.settings.color_scheme == 'highlight' %}
    style="--widget-bg-color: var(--bg-primary);"
  {% endif %}
  data-widget-id="{{ widget.id }}"
  data-widget-type="podcast-player"
  {% if widget.index != null %}data-widget-index="{{ widget.index }}"{% endif %}
>
  {% comment %} Get first block for initial display {% endcomment %}
  {% assign first_block_id = widget.blocksOrder | first %}
  {% assign first_block = widget.blocks[first_block_id] %}

  <style>
    .widget-{{ widget.id }} {
      & .audio-player-wrapper {
        background-color: var(--bg-primary);
        border: var(--border-width-thin) solid var(--border-color);
        padding: var(--space-lg);
        display: flex;
        flex-direction: column;
        gap: var(--space-xl);
      }

      & .audio-player-main-content {
        display: flex;
        flex-direction: column;
        gap: var(--space-lg);
      }

      & .audio-player-artwork {
        width: 100%;
        margin-inline: auto;
        flex-shrink: 0;
      }

      & .audio-player-artwork-image {
        width: 100%;
        height: auto;
        display: block;
        border: var(--border-width-thin) solid var(--border-color);
      }

      & .audio-player-info {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
        text-align: center;
      }

      & .audio-player-episode-meta {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: var(--space-md);
        margin-block-start: var(--space-xs);
      }

      & .audio-player-episode-meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
      }

      & .audio-player-episode-meta-icon {
        width: 1.4rem;
        height: 1.4rem;
        stroke: currentColor;
        stroke-width: 1.5;
        fill: none;
      }

      & .audio-player-controls {
        width: 100%;
      }

      & .audio-player-progress {
        margin-block-end: var(--space-lg);
      }

      & .audio-player-progress-bar {
        width: 100%;
        height: 0.6rem;
        background-color: var(--border-color);
        cursor: pointer;
        position: relative;
        margin-block-end: var(--space-xs);

        &:hover .audio-player-progress-fill::after {
          opacity: 1;
        }
      }

      & .audio-player-progress-fill {
        height: 100%;
        background-color: var(--text-heading);
        width: 0%;
        transition: width 0.1s linear;
        position: relative;

        &::after {
          content: "";
          position: absolute;
          inset-inline-end: -0.6rem;
          inset-block-start: 50%;
          transform: translateY(-50%);
          width: 1.2rem;
          height: 1.2rem;
          background-color: var(--text-heading);
          border-radius: 50%;
          opacity: 0;
          transition: opacity 0.2s;
        }
      }

      & .audio-player-progress-time {
        display: flex;
        justify-content: space-between;
        font-variant-numeric: tabular-nums;
      }

      & .audio-player-buttons {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-md);
        margin-block-end: var(--space-lg);
      }

      & .audio-player-button {
        background: none;
        border: none;
        cursor: pointer;
        padding: var(--space-xs);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s;
        color: var(--text-heading);

        &:hover {
          opacity: 0.7;
        }

        &:focus {
          outline: 2px solid var(--text-heading);
          outline-offset: 2px;
        }
      }

      & .audio-player-button-icon {
        width: 2.4rem;
        height: 2.4rem;
        stroke: currentColor;
        stroke-width: 1.5;
        fill: none;
      }

      & .audio-player-button-play {
        background-color: var(--text-heading);
        border-radius: 50%;
        padding: var(--space-sm);
        color: var(--bg-primary);

        &:hover {
          opacity: 0.8;
        }
      }

      & .audio-player-button-play .audio-player-button-icon {
        width: 2.4rem;
        height: 2.4rem;
        fill: currentColor;
        stroke: none;
      }

      & .audio-player-secondary-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-md);
      }

      & .audio-player-volume {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
        flex: 1;
        max-width: 12rem;
      }

      & .audio-player-volume-button {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: color 0.2s;

        &:hover {
          color: var(--text-heading);
        }
      }

      & .audio-player-volume-icon {
        width: 1.8rem;
        height: 1.8rem;
        stroke: currentColor;
        stroke-width: 2;
        fill: none;
        flex-shrink: 0;
      }

      & .audio-player-volume-slider {
        flex: 1;
        height: 0.6rem;
        background-color: var(--border-color);
        position: relative;
        cursor: pointer;
      }

      & .audio-player-volume-fill {
        height: 100%;
        background-color: var(--text-heading);
        width: 100%;
      }

      & .audio-player-speed-button {
        padding: var(--space-xs) var(--space-sm);
        font-family: inherit;
        background-color: var(--bg-primary);
        border: var(--border-width-thin) solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.2s;

        &:hover {
          background-color: var(--bg-secondary);
        }
      }

      & .playlist {
        display: flex;
        flex-direction: column;
        border: var(--border-width-thin) solid var(--border-color);
        max-height: 30rem;
        overflow-y: auto;
      }

      & .playlist-item {
        background-color: var(--bg-primary);
        padding: var(--space-md);
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: var(--space-md);
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s;
        text-align: start;
        border: none;
        border-block-end: var(--border-width-thin) solid var(--border-color);
        width: 100%;
        font-family: inherit;
        font-size: inherit;
        color: inherit;

        &:last-child {
          border-block-end: none;
        }

        &:hover {
          background-color: var(--bg-secondary);
        }

        &.active {
          background-color: var(--bg-secondary);
        }
      }

      & .playlist-index {
        font-size: var(--font-size-sm);
        min-width: 2rem;
      }

      & .playlist-info {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
        min-width: 0;
      }

      & .playlist-title {
        font-weight: var(--font-weight-semibold);
        color: var(--text-heading);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      & .playlist-meta {
        font-size: var(--font-size-sm);
      }

      & .playlist-duration {
        font-size: var(--font-size-sm);
        font-variant-numeric: tabular-nums;
      }

      @media (min-width: 750px) {
        & .audio-player-wrapper {
          padding: var(--space-2xl);
          flex-direction: row;
          gap: var(--space-2xl);
        }

        & .audio-player-main-content {
          flex: 1;
          flex-direction: row;
          gap: var(--space-xl);
        }

        & .audio-player-artwork {
          width: 20rem;
          margin-inline: 0;
        }

        & .audio-player-info-controls {
          flex: 1;
          display: flex;
          flex-direction: column;
        }

        & .audio-player-info {
          text-align: start;
        }

        & .audio-player-episode-meta {
          justify-content: flex-start;
        }

        & .playlist {
          width: 28rem;
          flex-shrink: 0;
        }
      }
    }
  </style>

  <div class="widget-container {% if widget.settings.color_scheme == 'highlight' %}widget-container-padded{% endif %}">
    {% if widget.settings.title != blank or widget.settings.description != blank or widget.settings.eyebrow != blank %}
      <div class="widget-header">
        {% assign header_delay = 0 %}
        {% if widget.settings.eyebrow != blank %}
          <span class="widget-eyebrow reveal reveal-up" style="--reveal-delay: {{ header_delay }}" data-setting="eyebrow">{{ widget.settings.eyebrow }}</span>
          {% assign header_delay = header_delay | plus: 1 %}
        {% endif %}
        {% if widget.settings.title != blank %}
          {% if widget.index == 1 %}
            <h1 class="widget-headline reveal reveal-up" style="--reveal-delay: {{ header_delay }}" data-setting="title">{{ widget.settings.title }}</h1>
          {% else %}
            <h2 class="widget-headline reveal reveal-up" style="--reveal-delay: {{ header_delay }}" data-setting="title">{{ widget.settings.title }}</h2>
          {% endif %}
          {% assign header_delay = header_delay | plus: 1 %}
        {% endif %}
        {% if widget.settings.description != blank %}
          <p class="widget-description reveal reveal-up" style="--reveal-delay: {{ header_delay }}" data-setting="description">{{ widget.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="widget-content">
      <div class="audio-player-wrapper reveal reveal-up">
        <!-- Main Player -->
        <div class="audio-player-main-content">
          <!-- Artwork -->
          <div class="audio-player-artwork" id="artwork-{{ widget.id }}">
            {% if first_block.settings.artwork != blank %}
              {{ first_block.settings.artwork | image: 'medium', 'audio-player-artwork-image', false }}
            {% else %}
              {% placeholder_image 'square', { "class": "audio-player-artwork-image" } %}
            {% endif %}
          </div>

          <!-- Info + Controls -->
          <div class="audio-player-info-controls">
            <div class="audio-player-info">
              {% assign item_heading_level = 'h3' %}
              {% if widget.settings.title == blank %}
                 {% assign item_heading_level = 'h2' %}
              {% endif %}

              {% if first_block.settings.episode_number != blank %}
                <span class="block-text block-text-sm block-text-uppercase" id="ep-number-{{ widget.id }}">{{ first_block.settings.episode_number }}</span>
              {% endif %}
              <{{ item_heading_level }} class="block-text block-text-xl block-text-heading-weight block-text-heading" id="ep-title-{{ widget.id }}">{{ first_block.settings.title }}</{{ item_heading_level }}>

              <div class="audio-player-episode-meta block-text block-text-sm">
                {% if first_block.settings.duration != blank %}
                <div class="audio-player-episode-meta-item">
                  <svg class="audio-player-episode-meta-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                  </svg>
                  <span id="ep-duration-{{ widget.id }}">{{ first_block.settings.duration }}</span>
                </div>
                {% endif %}
                {% if first_block.settings.date != blank %}
                <div class="audio-player-episode-meta-item">
                  <svg class="audio-player-episode-meta-icon" viewBox="0 0 24 24">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                  </svg>
                  <span id="ep-date-{{ widget.id }}">{{ first_block.settings.date }}</span>
                </div>
                {% endif %}
              </div>

              {% if first_block.settings.description != blank %}
                <p class="block-text block-text-base" id="ep-desc-{{ widget.id }}">{{ first_block.settings.description }}</p>
              {% endif %}
            </div>

            <div class="audio-player-controls">
              <!-- Progress -->
              <div class="audio-player-progress">
                <div
                  class="audio-player-progress-bar"
                  role="slider"
                  aria-label="Seek"
                  aria-valuemin="0"
                  aria-valuemax="0"
                  aria-valuenow="0"
                  aria-valuetext="0:00"
                  tabindex="0"
                >
                  <div class="audio-player-progress-fill"></div>
                </div>
                <div class="audio-player-progress-time block-text block-text-sm">
                  <span class="audio-player-current-time">0:00</span>
                  <span class="audio-player-total-duration">{{ first_block.settings.duration | default: '0:00' }}</span>
                </div>
              </div>

              <!-- Buttons -->
              <div class="audio-player-buttons">
                <button class="audio-player-button" aria-label="Rewind 15 seconds" data-action="rewind">
                  <svg class="audio-player-button-icon" viewBox="0 0 24 24">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                    <text x="12" y="15" font-size="7" text-anchor="middle" fill="currentColor" stroke="none" font-weight="bold">15</text>
                  </svg>
                </button>

                <button class="audio-player-button audio-player-button-play" aria-label="Play" data-action="play">
                  <svg class="audio-player-button-icon audio-player-icon-play" viewBox="0 0 24 24">
                    <polygon points="6 4 18 12 6 20 6 4" />
                  </svg>
                  <svg class="audio-player-button-icon audio-player-icon-pause" viewBox="0 0 24 24" style="display: none;">
                    <rect x="6" y="4" width="4" height="16" rx="1" />
                    <rect x="14" y="4" width="4" height="16" rx="1" />
                  </svg>
                </button>

                <button class="audio-player-button" aria-label="Forward 15 seconds" data-action="forward">
                  <svg class="audio-player-button-icon" viewBox="0 0 24 24">
                    <path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                    <path d="M21 3v5h-5"/>
                    <text x="12" y="15" font-size="7" text-anchor="middle" fill="currentColor" stroke="none" font-weight="bold">15</text>
                  </svg>
                </button>
              </div>

              <!-- Secondary -->
              <div class="audio-player-secondary-controls">
                {% if widget.settings.show_volume %}
                <div class="audio-player-volume">
                  <button class="audio-player-volume-button" aria-label="Mute" data-action="mute">
                    <svg class="audio-player-volume-icon audio-player-icon-volume" viewBox="0 0 24 24">
                      <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                      <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
                      <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
                    </svg>
                    <svg class="audio-player-volume-icon audio-player-icon-mute" viewBox="0 0 24 24" style="display: none;">
                      <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                      <line x1="23" y1="9" x2="17" y2="15" />
                      <line x1="17" y1="9" x2="23" y2="15" />
                    </svg>
                  </button>
                  <div
                    class="audio-player-volume-slider"
                    role="slider"
                    aria-label="Volume"
                    aria-valuemin="0"
                    aria-valuemax="100"
                    aria-valuenow="100"
                    aria-valuetext="100%"
                    tabindex="0"
                  >
                    <div class="audio-player-volume-fill"></div>
                  </div>
                </div>
                {% endif %}

                {% if widget.settings.show_speed %}
                <button class="audio-player-speed-button block-text block-text-sm" aria-label="Playback speed" data-action="speed">1x</button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Playlist -->
        {% if widget.blocksOrder.size > 1 %}
        <div class="playlist">
          {% for blockId in widget.blocksOrder %}
            {% assign block = widget.blocks[blockId] %}
            <button
              class="playlist-item {% if forloop.first %}active{% endif %}"
              data-block-id="{{ blockId }}"
              data-title="{{ block.settings.title | escape }}"
              data-number="{{ block.settings.episode_number | escape }}"
              data-duration="{{ block.settings.duration | escape }}"
              data-date="{{ block.settings.date | escape }}"
              data-description="{{ block.settings.description | escape }}"
              data-audio-src="{{ block.settings.audio_file | audio: 'path' }}"
            >
              <div class="playlist-index">{{ forloop.index }}</div>
              <div class="playlist-info">
                <div class="playlist-title">{{ block.settings.title }}</div>
                <div class="playlist-meta">{{ block.settings.date }}</div>
              </div>
              <div class="playlist-duration">{{ block.settings.duration }}</div>

              <!-- Hidden artwork for JS -->
              <template class="hidden-artwork">
                {% if block.settings.artwork != blank %}
                  {{ block.settings.artwork | image: 'medium', 'audio-player-artwork-image', false }}
                {% else %}
                  {% placeholder_image 'square', { "class": "audio-player-artwork-image" } %}
                {% endif %}
              </template>
            </button>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Audio Element -->
  {% if first_block.settings.audio_file != blank %}
  <audio class="audio-player-audio" preload="metadata" src="{{ first_block.settings.audio_file | audio: 'path' }}">
    Your browser does not support the audio element.
  </audio>
  {% else %}
  <audio class="audio-player-audio" preload="metadata"></audio>
  {% endif %}

  <script>
    (function () {
      const widget = document.getElementById('{{ widget.id }}');
      if (!widget || widget.dataset.initialized) return;
      widget.dataset.initialized = 'true';

      const audio = widget.querySelector('.audio-player-audio');
      const playButton = widget.querySelector('[data-action="play"]');
      const rewindButton = widget.querySelector('[data-action="rewind"]');
      const forwardButton = widget.querySelector('[data-action="forward"]');
      const speedButton = widget.querySelector('[data-action="speed"]');
      const progressBar = widget.querySelector('.audio-player-progress-bar');
      const progressFill = widget.querySelector('.audio-player-progress-fill');
      const currentTimeEl = widget.querySelector('.audio-player-current-time');
      const totalDurationEl = widget.querySelector('.audio-player-total-duration');
      const muteButton = widget.querySelector('[data-action="mute"]');
      const volumeIcon = widget.querySelector('.audio-player-icon-volume');
      const muteIcon = widget.querySelector('.audio-player-icon-mute');
      const volumeSlider = widget.querySelector('.audio-player-volume-slider');
      const volumeFill = widget.querySelector('.audio-player-volume-fill');
      const playIcon = widget.querySelector('.audio-player-icon-play');
      const pauseIcon = widget.querySelector('.audio-player-icon-pause');
      const playlistItems = widget.querySelectorAll('.playlist-item');

      const artworkEl = widget.querySelector('#artwork-{{ widget.id }}');
      const titleEl = widget.querySelector('#ep-title-{{ widget.id }}');
      const numberEl = widget.querySelector('#ep-number-{{ widget.id }}');
      const durationEl = widget.querySelector('#ep-duration-{{ widget.id }}');
      const dateEl = widget.querySelector('#ep-date-{{ widget.id }}');
      const descEl = widget.querySelector('#ep-desc-{{ widget.id }}');

      if (!playButton) return;

      let isPlaying = false;
      let currentSpeed = 1;
      const speeds = [1, 1.25, 1.5, 1.75, 2];

      const formatTime = (seconds) => {
        if (isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      const updateProgressAria = () => {
        if (!progressBar || !audio || !audio.duration) return;
        progressBar.setAttribute('aria-valuemin', '0');
        progressBar.setAttribute('aria-valuemax', String(Math.floor(audio.duration)));
        progressBar.setAttribute('aria-valuenow', String(Math.floor(audio.currentTime)));
        progressBar.setAttribute('aria-valuetext', formatTime(audio.currentTime));
      };

      const updateVolumeAria = () => {
        if (!volumeSlider || !audio) return;
        const volumePercent = Math.round((audio.volume || 0) * 100);
        volumeSlider.setAttribute('aria-valuemin', '0');
        volumeSlider.setAttribute('aria-valuemax', '100');
        volumeSlider.setAttribute('aria-valuenow', String(volumePercent));
        volumeSlider.setAttribute('aria-valuetext', `${volumePercent}%`);
      };

      const setPlayingState = (playing) => {
        isPlaying = playing;
        playIcon.style.display = playing ? 'none' : 'block';
        pauseIcon.style.display = playing ? 'block' : 'none';
        playButton.setAttribute('aria-label', playing ? 'Pause' : 'Play');
      };

      // Play/Pause
      playButton.addEventListener('click', () => {
        if (!audio) return;
        if (isPlaying) {
          audio.pause();
        } else {
          audio.play().catch(() => {});
        }
        setPlayingState(!isPlaying);
      });

      // Playlist
      playlistItems.forEach(item => {
        item.addEventListener('click', () => {
          playlistItems.forEach(i => i.classList.remove('active'));
          item.classList.add('active');

          const src = item.dataset.audioSrc;
          if (titleEl) titleEl.textContent = item.dataset.title || '';
          if (numberEl) numberEl.textContent = item.dataset.number || '';
          if (durationEl) durationEl.textContent = item.dataset.duration || '';
          if (dateEl) dateEl.textContent = item.dataset.date || '';
          if (descEl) descEl.textContent = item.dataset.description || '';
          if (totalDurationEl) totalDurationEl.textContent = item.dataset.duration || '0:00';

          const artworkTemplate = item.querySelector('.hidden-artwork');
          if (artworkEl && artworkTemplate) {
            artworkEl.innerHTML = artworkTemplate.innerHTML;
          }

          if (audio && src) {
            audio.src = src;
            audio.load();
            if (progressFill) progressFill.style.width = '0%';
            if (currentTimeEl) currentTimeEl.textContent = '0:00';

            audio.play().then(() => setPlayingState(true)).catch(() => setPlayingState(false));
          }
        });
      });

      // Skip controls
      if (rewindButton && audio) {
        rewindButton.addEventListener('click', () => {
          audio.currentTime = Math.max(0, audio.currentTime - 15);
        });
      }

      if (forwardButton && audio) {
        forwardButton.addEventListener('click', () => {
          audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 15);
        });
      }

      // Speed
      if (speedButton && audio) {
        speedButton.addEventListener('click', function () {
          const idx = speeds.indexOf(currentSpeed);
          currentSpeed = speeds[(idx + 1) % speeds.length];
          audio.playbackRate = currentSpeed;
          this.textContent = `${currentSpeed}x`;
        });
      }

      // Progress
      if (audio) {
        audio.addEventListener('timeupdate', () => {
          if (!audio.duration) return;
          const pct = (audio.currentTime / audio.duration) * 100;
          if (progressFill) progressFill.style.width = `${pct}%`;
          if (currentTimeEl) currentTimeEl.textContent = formatTime(audio.currentTime);
          updateProgressAria();
        });

        audio.addEventListener('loadedmetadata', () => {
          if (totalDurationEl) totalDurationEl.textContent = formatTime(audio.duration);
          updateProgressAria();
        });

        audio.addEventListener('ended', () => {
          const active = widget.querySelector('.playlist-item.active');
          if (active && active.nextElementSibling) {
            active.nextElementSibling.click();
          } else {
            setPlayingState(false);
          }
        });
      }

      // Seek
      if (progressBar && audio) {
        progressBar.addEventListener('click', (e) => {
          const rect = progressBar.getBoundingClientRect();
          const pos = (e.clientX - rect.left) / rect.width;
          audio.currentTime = pos * (audio.duration || 0);
          updateProgressAria();
        });

        progressBar.addEventListener('keydown', (e) => {
          if (!audio.duration) return;
          let nextTime = audio.currentTime;
          switch (e.key) {
            case 'ArrowRight':
              nextTime += 5;
              break;
            case 'ArrowLeft':
              nextTime -= 5;
              break;
            case 'PageUp':
              nextTime += 10;
              break;
            case 'PageDown':
              nextTime -= 10;
              break;
            case 'Home':
              nextTime = 0;
              break;
            case 'End':
              nextTime = audio.duration;
              break;
            default:
              return;
          }
          e.preventDefault();
          audio.currentTime = Math.max(0, Math.min(audio.duration, nextTime));
          updateProgressAria();
        });
      }

      // Volume
      let lastVolume = 1;
      const updateVolumeIcon = (vol) => {
        if (volumeIcon && muteIcon) {
          volumeIcon.style.display = vol === 0 ? 'none' : 'block';
          muteIcon.style.display = vol === 0 ? 'block' : 'none';
        }
      };

      if (muteButton && audio) {
        muteButton.addEventListener('click', () => {
          if (audio.volume > 0) {
            lastVolume = audio.volume;
            audio.volume = 0;
            if (volumeFill) volumeFill.style.width = '0%';
            updateVolumeIcon(0);
            updateVolumeAria();
          } else {
            audio.volume = lastVolume || 1;
            if (volumeFill) volumeFill.style.width = `${audio.volume * 100}%`;
            updateVolumeIcon(audio.volume);
            updateVolumeAria();
          }
        });
      }

      if (volumeSlider && audio && volumeFill) {
        const updateVol = (e) => {
          const rect = volumeSlider.getBoundingClientRect();
          let pos = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
          audio.volume = pos;
          volumeFill.style.width = `${pos * 100}%`;
          updateVolumeIcon(pos);
          if (pos > 0) lastVolume = pos;
          updateVolumeAria();
        };

        let dragging = false;
        volumeSlider.addEventListener('mousedown', (e) => { dragging = true; updateVol(e); });
        document.addEventListener('mousemove', (e) => { if (dragging) updateVol(e); });
        document.addEventListener('mouseup', () => { dragging = false; });
        volumeSlider.addEventListener('click', updateVol);

        volumeSlider.addEventListener('keydown', (e) => {
          let next = audio.volume;
          switch (e.key) {
            case 'ArrowRight':
            case 'ArrowUp':
              next += 0.05;
              break;
            case 'ArrowLeft':
            case 'ArrowDown':
              next -= 0.05;
              break;
            case 'PageUp':
              next += 0.1;
              break;
            case 'PageDown':
              next -= 0.1;
              break;
            case 'Home':
              next = 0;
              break;
            case 'End':
              next = 1;
              break;
            default:
              return;
          }
          e.preventDefault();
          next = Math.max(0, Math.min(1, next));
          audio.volume = next;
          volumeFill.style.width = `${next * 100}%`;
          updateVolumeIcon(next);
          if (next > 0) lastVolume = next;
          updateVolumeAria();
        });
      }
    })();
  </script>
</section>
