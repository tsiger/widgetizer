<section
  id="{{ widget.id }}"
  class="widget widget-comparison-table widget-{{ widget.id }} color-scheme-{{ widget.settings.color_scheme }}"
  {% if widget.settings.color_scheme == 'dark' %}
    style="--widget-bg-color: var(--bg-primary);"
  {% endif %}
  data-widget-id="{{ widget.id }}"
  data-widget-type="comparison-table"
  {% if widget.index != null %}data-widget-index="{{ widget.index }}"{% endif %}
>
  <style>
    .widget-{{ widget.id }} {
      & .comparison-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-inline: calc(var(--space-lg) * -1);
        padding-inline: var(--space-lg);
      }

      & .comparison-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 60rem;
      }

      & .comparison-table-head {
        background-color: var(--bg-secondary);
      }

      & .comparison-table-th {
        padding: var(--space-lg) var(--space-md);
        text-align: center;
        border-block-end: var(--border-width-medium) solid var(--border-color);
        vertical-align: top;

        &:first-child {
          text-align: start;
          padding-inline-start: var(--space-lg);
        }
      }

      & .comparison-table-th-featured {
        position: relative;
        border: var(--border-width-medium) solid var(--accent);
        border-block-end-color: var(--accent);
      }

      & .comparison-table-badge {
        display: block;
        background-color: var(--accent);
        color: var(--accent-text);
        padding: 0.4rem 0.8rem;
        margin-block-start: var(--space-xs);
        width: fit-content;
        margin-inline: auto;
      }

      & .comparison-table-body {
        & tr:nth-child(even) {
          background-color: var(--bg-secondary);
        }
      }

      & .comparison-table-td {
        padding: var(--space-md) var(--space-md);
        text-align: center;
        border-block-end: var(--border-width-thin) solid var(--border-color);
        vertical-align: middle;

        &:first-child {
          text-align: start;
          padding-inline-start: var(--space-lg);
        }
      }

      & .comparison-table-td-featured {
        border-inline-start: var(--border-width-medium) solid var(--accent);
        border-inline-end: var(--border-width-medium) solid var(--accent);
        border-block-end-color: var(--border-color);
      }

      & .comparison-table-body tr:last-child .comparison-table-td-featured {
        border-block-end: var(--border-width-medium) solid var(--accent);
      }

      & .comparison-table-check {
        font-size: var(--font-size-2xl);
        line-height: 1;
      }

      & .comparison-table-cross {
        font-size: var(--font-size-2xl);
        line-height: 1;
      }

      & .comparison-table-footer {
        text-align: center;
        margin-block-start: var(--space-2xl);
      }

      @media (min-width: 750px) {
        & .comparison-table-wrapper {
          margin-inline: 0;
          padding-inline: 0;
        }

        & .comparison-table {
          min-width: 0;
        }

        & .comparison-table-th {
          padding: var(--space-xl) var(--space-lg);

          &:first-child {
            padding-inline-start: var(--space-xl);
          }
        }

        & .comparison-table-badge {
          padding: 0.6rem 1.2rem;
        }

        & .comparison-table-td {
          padding: var(--space-lg) var(--space-lg);

          &:first-child {
            padding-inline-start: var(--space-xl);
          }
        }

        & .comparison-table-check,
        & .comparison-table-cross {
          font-size: var(--font-size-3xl);
        }
      }
    }
  </style>

  {% comment %} Collect columns and features separately {% endcomment %}
  {% assign columns = '' %}
  {% assign features = '' %}
  {% for blockId in widget.blocksOrder %}
    {% assign block = widget.blocks[blockId] %}
    {% if block.type == 'column' %}
      {% if columns == '' %}
        {% assign columns = blockId %}
      {% else %}
        {% assign columns = columns | append: ',' | append: blockId %}
      {% endif %}
    {% elsif block.type == 'feature' %}
      {% if features == '' %}
        {% assign features = blockId %}
      {% else %}
        {% assign features = features | append: ',' | append: blockId %}
      {% endif %}
    {% endif %}
  {% endfor %}
  {% assign column_ids = columns | split: ',' %}
  {% assign feature_ids = features | split: ',' %}

  <div class="widget-container {% if widget.settings.color_scheme == 'dark' %}widget-container-padded{% endif %}">
    {% if widget.settings.title != blank or widget.settings.description != blank or widget.settings.eyebrow != blank %}
      <div class="widget-header">
        {% if widget.settings.eyebrow != blank %}
          <span class="widget-eyebrow" data-setting="eyebrow">{{ widget.settings.eyebrow }}</span>
        {% endif %}
        {% if widget.settings.title != blank %}
          {% if widget.index == 1 %}
            <h1 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h1>
          {% else %}
            <h2 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h2>
          {% endif %}
        {% endif %}
        {% if widget.settings.description != blank %}
          <p class="widget-description" data-setting="description">{{ widget.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="widget-content">
      <div class="comparison-table-wrapper">
        <table class="comparison-table">
          <thead class="comparison-table-head">
            <tr>
              <th class="comparison-table-th">{{ widget.settings.feature_column_label | default: 'Features' }}</th>
              {% for colId in column_ids %}
                {% assign col = widget.blocks[colId] %}
                <th
                  class="comparison-table-th {% if col.settings.featured %}comparison-table-th-featured{% endif %}"
                  data-block-id="{{ colId }}"
                  {{ col.shopify_attributes }}
                >
                  <div class="block-text block-text-sm block-text-heading" data-setting="name">{{ col.settings.name }}</div>
                  {% if col.settings.badge != blank %}
                    <span class="comparison-table-badge block-text block-text-xs block-text-uppercase" data-setting="badge">{{ col.settings.badge }}</span>
                  {% endif %}
                </th>
              {% endfor %}
            </tr>
          </thead>

          <tbody class="comparison-table-body">
            {% for featureId in feature_ids %}
              {% assign feature = widget.blocks[featureId] %}
              {% assign values = feature.settings.values | split: '
' %}
              <tr data-block-id="{{ featureId }}" {{ feature.shopify_attributes }}>
                <td class="comparison-table-td block-text block-text-heading" data-setting="name">{{ feature.settings.name }}</td>
                {% for colId in column_ids %}
                  {% assign col = widget.blocks[colId] %}
                  {% assign col_index = forloop.index0 %}
                  {% assign value = values[col_index] | strip %}
                  <td class="comparison-table-td {% if col.settings.featured %}comparison-table-td-featured{% endif %}">
                    {% if value == '✓' or value == 'yes' or value == 'Yes' or value == 'true' %}
                      <span class="comparison-table-check block-text block-text-heading" aria-label="Included">✓</span>
                    {% elsif value == '✗'
                      or value == 'no'
                      or value == 'No'
                      or value == 'false'
                      or value == 'x'
                      or value == 'X'
                    %}
                      <span class="comparison-table-cross block-text block-text-muted" aria-label="Not included">✗</span>
                    {% elsif value != blank %}
                      <span class="block-text">{{ value }}</span>
                    {% else %}
                      <span class="comparison-table-cross block-text block-text-muted" aria-label="Not included">✗</span>
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if widget.settings.cta_link.text != blank %}
        <div class="comparison-table-footer">
          <a
            href="{{ widget.settings.cta_link.href }}"
            class="widget-button widget-button-primary"
            {% if widget.settings.cta_link.target == '_blank' %}
              target="_blank" rel="noopener"
            {% endif %}
          >
            {{ widget.settings.cta_link.text }}
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</section>
