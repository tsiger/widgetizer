<section
  id="{{ widget.id }}"
  class="widget widget-bento-grid widget-{{ widget.id }} color-scheme-{{ widget.settings.color_scheme }}"
  {% if widget.settings.color_scheme == 'dark' %}
    style="--widget-bg-color: var(--bg-primary);"
  {% endif %}
  data-widget-id="{{ widget.id }}"
  data-widget-type="bento-grid"
  {% if widget.index != null %}data-widget-index="{{ widget.index }}"{% endif %}
>
  <style>
    .widget-{{ widget.id }} {
      & .bento-grid-container {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: var(--space-md);
      }

      & .bento-item {
        display: flex;
        flex-direction: column;
        padding: var(--space-xl);
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        border: var(--border-width-thin) solid var(--border-color);
        text-decoration: none;
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), border-color 0.3s ease;
        min-height: 20rem;
        justify-content: flex-end;

        &.has-bg-color,
        &.has-bg-image {
          border: none;
        }

        &.align-center { align-items: center; text-align: center; }
        &.align-start { align-items: flex-start; text-align: start; }

        &:hover {
          transform: translateY(-0.4rem);
          border-color: var(--border-color);
        }
      }

      & .bento-content {
        position: relative;
        z-index: 3;
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
        width: 100%;
      }

      @media (min-width: 990px) {
        & .bento-grid-container {
          grid-template-columns: repeat(4, 1fr);
        }

        {% for blockId in widget.blocksOrder %}
          {% assign block = widget.blocks[blockId] %}
          & [data-block-id="{{ blockId }}"] {
            grid-column: span {{ block.settings.col_span | default: 1 | min: 4 }};
            grid-row: span {{ block.settings.row_span | default: 1 }};
          }
        {% endfor %}
      }
    }
  </style>

  <div class="widget-container {% if widget.settings.color_scheme == 'dark' %}widget-container-padded{% endif %}">
    {% if widget.settings.title != blank or widget.settings.description != blank or widget.settings.eyebrow != blank %}
      <div class="widget-header">
        {% if widget.settings.eyebrow != blank %}
          <span class="widget-eyebrow" data-setting="eyebrow">{{ widget.settings.eyebrow }}</span>
        {% endif %}
        {% if widget.settings.title != blank %}
          {% if widget.index == 1 %}
            <h1 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h1>
          {% else %}
            <h2 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h2>
          {% endif %}
        {% endif %}
        {% if widget.settings.description != blank %}
          <p class="widget-description" data-setting="description">{{ widget.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="widget-content">
      <div class="bento-grid-container">
        {% comment %} Determine heading levels {% endcomment %}
        {% assign has_widget_title = false %}
        {% if widget.settings.title != blank %}
          {% assign has_widget_title = true %}
        {% endif %}

        {% assign first_item_level = 'h2' %}
        {% assign other_items_level = 'h2' %}

        {% if has_widget_title %}
          {% if widget.index == 1 %}
            {% assign first_item_level = 'h2' %}
            {% assign other_items_level = 'h2' %}
          {% else %}
            {% assign first_item_level = 'h3' %}
            {% assign other_items_level = 'h3' %}
          {% endif %}
        {% else %}
          {% if widget.index == 1 %}
            {% assign first_item_level = 'h1' %}
            {% assign other_items_level = 'h2' %}
          {% else %}
            {% assign first_item_level = 'h2' %}
            {% assign other_items_level = 'h2' %}
          {% endif %}
        {% endif %}

        {% for blockId in widget.blocksOrder %}
          {% assign block = widget.blocks[blockId] %}

          {% assign item_classes = 'bento-item block-item' | append: ' align-' | append: block.settings.alignment %}
          {% assign item_style = '' %}

          {% if block.settings.image != blank %}
             {% assign item_classes = item_classes | append: ' has-bg-image has-overlay' %}

             {% assign overlay_val = block.settings.overlay_color | default: 'rgba(0,0,0,0.5)' %}
             {% capture item_style %}
               {{ item_style }} --widget-overlay-color: {{ overlay_val }}; background-image: url('{{ block.settings.image | image: 'path', 'large' }}');
             {% endcapture %}

          {% elsif block.settings.background_color != blank %}
             {% assign item_classes = item_classes | append: ' has-bg-color' %}
             {% capture item_style %}
               {{ item_style }} --widget-bg-color: {{ block.settings.background_color }};
             {% endcapture %}
          {% endif %}

          {% if block.settings.text_color == 'light' %}
             {% assign item_classes = item_classes | append: ' color-scheme-dark' %}
          {% elsif block.settings.text_color == 'dark' %}
             {% assign item_classes = item_classes | append: ' color-scheme-light' %}
          {% endif %}

          <{% if block.settings.link.href != blank %}a href="{{ block.settings.link.href }}"{% else %}div{% endif %}
            class="{{ item_classes }}"
            style="{{ item_style }}"
            data-block-id="{{ blockId }}"
          >
            <div class="bento-content">
              {% if block.settings.title != blank %}
                {% if forloop.first %}
                  <{{ first_item_level }} class="widget-title block-text block-text-xl block-text-bold block-text-heading" data-setting="title">{{ block.settings.title }}</{{ first_item_level }}>
                {% else %}
                  <{{ other_items_level }} class="widget-title block-text block-text-xl block-text-bold block-text-heading" data-setting="title">{{ block.settings.title }}</{{ other_items_level }}>
                {% endif %}
              {% endif %}
              {% if block.settings.text != blank %}
                <p class="widget-description block-text block-text-sm" data-setting="text">{{ block.settings.text }}</p>
              {% endif %}
            </div>
          </{% if block.settings.link.href != blank %}a{% else %}div{% endif %}>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

