<header id="{{ widget.id }}" class="widget-site-header" data-widget-id="{{ widget.id }}" data-widget-type="header">
  <style>
    #{{ widget.id }} {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-block: var(--space-md);
      padding-inline: var(--space-md);
      border-block-end: var(--border-width-thin) solid var(--border-light);

      & .header-logo {
        display: block;
        text-decoration: none;
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
        z-index: 1001;
      }

      & .header-actions {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        z-index: 1001;
      }

      & .menu-toggle {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 4.4rem; /* 44px */
        height: 4.4rem;
        padding: 0;
        background: transparent;
        border: none;
        cursor: pointer;

        & .icon-menu,
        & .icon-close {
          width: 2.4rem; /* 24px */
          height: 2.4rem;
          display: block;
        }

        & .icon-close {
          display: none;
        }

        &[aria-expanded='true'] {
          & .icon-menu {
            display: none;
          }

          & .icon-close {
            display: block;
          }
        }
      }

      & .header-nav {
        position: fixed;
        inset-block-start: 0;
        inset-inline-end: -32rem; /* -320px */
        width: 32rem; /* 320px */
        max-width: 85vw;
        height: 100vh;
        background-color: var(--bg-primary);
        padding-block-start: var(--space-md);
        padding-inline: var(--space-lg);
        overflow-y: auto;
        transition: inset-inline-end 0.3s ease-in-out;
        z-index: 1000;

        &.nav-open {
          inset-inline-end: 0;
        }
      }

      & .nav-close {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-block-end: var(--space-xl);
        padding-block-end: var(--space-md);
        border-block-end: var(--border-width-thin) solid var(--border-light);

        & .nav-close-title {
          font-size: var(--font-size-lg);
          font-weight: var(--font-weight-semibold);
        }

        & .nav-close-btn {
          display: flex;
          justify-content: center;
          align-items: center;
          width: 4rem; /* 40px */
          height: 4rem;
          padding: 0;
          background: transparent;
          border: none;
          cursor: pointer;

          & svg {
            width: 2.4rem; /* 24px */
            height: 2.4rem;
          }
        }
      }

      & .nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      & .nav-item {
        & > a,
        & > button {
          display: flex;
          justify-content: space-between;
          align-items: center;
          width: 100%;
          padding-block: 1.4rem; /* 14px adjusted */
          padding-inline: 0;
          text-decoration: none;
          color: var(--text-primary);
          font-weight: var(--font-weight-normal);
          font-size: var(--font-size-base);
          background: transparent;
          border: none;
          text-align: start;
          cursor: pointer;
          transition: color 0.2s;

          &:hover {
            color: var(--text-muted);
          }
        }

        /* Chevron icon for items with submenus */
        &.has-submenu > a::after {
          content: '';
          display: inline-block;
          width: 2rem;
          height: 2rem;
          margin-inline-start: auto;
          flex-shrink: 0;
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9 6l6 6l-6 6'/%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: center;
          background-size: contain;
          transition: transform 0.3s;
        }
      }

      & .nav-submenu {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;

        &.submenu-open {
          max-height: 1000px;
        }

        & .nav-item {
          padding-inline-start: var(--space-lg);

          & > a,
          & > button {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-normal);
            padding-block: 1.2rem; /* 12px */
          }
        }

        & .nav-submenu {
          & .nav-item {
            padding-inline-start: var(--space-lg);

            & > a,
            & > button {
              font-size: var(--font-size-sm);
            }
          }
        }
      }

      & .mobile-cta {
        margin-block-start: var(--space-xl);
        width: 100%;
        text-align: center;
      }

      & .desktop-cta {
        display: none;
      }

      @media (min-width: 990px) {
        & {
          padding-inline: var(--space-xl);
        }

        & .header-actions {
          flex: 1;
          justify-content: flex-end;
        }

        & .menu-toggle {
          display: none;
        }

        & .nav-close {
          display: none;
        }

        & .header-nav {
          position: static;
          width: auto;
          height: auto;
          display: flex;
          align-items: center;
          background-color: transparent;
          padding: 0;
          overflow: visible;
          transform: none;
          box-shadow: none;
        }

        & .nav-list {
          display: flex;
          gap: var(--space-xs);
          align-items: center;
        }

        & .nav-item {
          position: relative;

          & > a,
          & > button {
            padding-block: 1rem; /* 10px */
            padding-inline: var(--space-md);
            font-size: var(--font-size-sm);
            transition: background-color 0.2s;

            &:hover {
              background-color: var(--bg-secondary);
              color: var(--text-primary);
            }
          }

          /* Desktop chevron styling */
          &.has-submenu > a::after {
            width: 1.6rem;
            height: 1.6rem;
            margin-inline-start: var(--space-xs);
            transform: rotate(90deg);
          }

          &:hover > .nav-submenu,
          &:focus-within > .nav-submenu {
            max-height: none;
            display: block;
          }
        }

        & .nav-submenu {
          position: absolute;
          inset-block-start: calc(100% - 0.4rem);
          inset-inline-start: 0;
          min-width: 22rem; /* 220px */
          background-color: var(--bg-primary);
          border: var(--border-width-thin) solid var(--border-light);
          display: none;
          max-height: none;
          overflow: visible;
          padding-block: var(--space-xs);
          padding-inline: 0;

          & .nav-item {
            padding: 0;
            & > a,
            & > button {
              padding-block: 1.2rem; /* 12px */
              padding-inline: var(--space-md);
              font-size: var(--font-size-sm);
              transition: background-color 0.2s;
              &:hover {
                background-color: var(--bg-secondary);
              }
            }
            /* Reset chevron rotation in nested submenus */
            &.has-submenu > a::after {
              transform: rotate(0deg);
            }
          }

          & .nav-submenu {
            position: absolute;
            inset-block-start: -0.8rem; /* -8px adjusted */
            inset-inline-start: calc(100% - 0.4rem);
            min-width: 22rem; /* 220px */
            background-color: var(--bg-primary);
            border: var(--border-width-thin) solid var(--border-light);
            padding-block: var(--space-xs);
            padding-inline: 0;
            display: none;
            & .nav-item {
              padding: 0;
            }
          }

          &:hover > .nav-submenu,
          &:focus-within > .nav-submenu {
            display: block;
          }
        }

        & .mobile-cta {
          display: none;
        }

        & .desktop-cta {
          display: inline-block;
          margin-inline-start: var(--space-md);
        }
      }
    }
  </style>

  <a href="/" class="header-logo">{{ widget.settings.logoText | default: 'Widgetizer' }}</a>

  <div class="header-actions">
    <nav class="header-nav" id="main-navigation">
      <div class="nav-close">
        <span class="nav-close-title">Menu</span>
        <button class="nav-close-btn" aria-label="Close navigation menu">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M18 6l-12 12" />
            <path d="M6 6l12 12" />
          </svg>
        </button>
      </div>
      {% if widget.settings.headerNavigation %}
        {% render 'menu',
          menu: widget.settings.headerNavigation,
          class_list: 'nav-list',
          class_item: 'nav-item',
          class_link: '',
          class_submenu: 'nav-submenu',
          class_has_submenu: 'has-submenu'
        %}
      {% endif %}
      {% if widget.settings.ctaButtonLink.text != blank %}
        <a href="{{ widget.settings.ctaButtonLink.href | default: '#' }}" class="widget-button mobile-cta" {% if widget.settings.ctaButtonLink.target == '_blank' %}target="_blank" rel="noopener noreferrer"{% endif %}>
          {{ widget.settings.ctaButtonLink.text }}
        </a>
      {% endif %}
    </nav>

    {% if widget.settings.ctaButtonLink.text != blank %}
      <a href="{{ widget.settings.ctaButtonLink.href | default: '#' }}" class="widget-button desktop-cta" {% if widget.settings.ctaButtonLink.target == '_blank' %}target="_blank" rel="noopener noreferrer"{% endif %}>
        {{ widget.settings.ctaButtonLink.text }}
      </a>
    {% endif %}

    <button
      class="menu-toggle"
      aria-label="Toggle navigation menu"
      aria-expanded="false"
      aria-controls="main-navigation"
    >
      <svg
        class="icon-menu"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M4 6l16 0" />
        <path d="M4 12l16 0" />
        <path d="M4 18l16 0" />
      </svg>
      <svg
        class="icon-close"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M18 6l-12 12" />
        <path d="M6 6l12 12" />
      </svg>
    </button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const widgetElement = document.getElementById('{{ widget.id }}');
      if (!widgetElement) return;

      const menuToggle = widgetElement.querySelector('.menu-toggle');
      const navCloseBtn = widgetElement.querySelector('.nav-close-btn');
      const headerNav = widgetElement.querySelector('.header-nav');
      // Select links within has-submenu items as toggles
      const submenuItems = widgetElement.querySelectorAll('.has-submenu');

      // Function to open mobile menu
      const openMobileMenu = () => {
        menuToggle.setAttribute('aria-expanded', 'true');
        headerNav.classList.add('nav-open');
        document.body.style.overflow = 'hidden';

        // Focus the close button when menu opens
        setTimeout(() => {
          if (navCloseBtn) {
            navCloseBtn.focus();
          }
        }, 100);
      };

      // Function to close mobile menu
      const closeMobileMenu = () => {
        menuToggle.setAttribute('aria-expanded', 'false');
        headerNav.classList.remove('nav-open');
        document.body.style.overflow = '';
      };

      // Focus trap for mobile menu
      const trapFocus = (e) => {
        if (window.innerWidth >= 990) return;
        if (!headerNav.classList.contains('nav-open')) return;

        const focusableElements = headerNav.querySelectorAll(
          'button:not([disabled]), a[href]:not([disabled]), [tabindex]:not([tabindex="-1"])',
        );
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.key === 'Tab') {
          if (e.shiftKey) {
            // Shift + Tab
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            // Tab
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
      };

      document.addEventListener('keydown', trapFocus);

      // Mobile menu toggle
      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
          if (isExpanded) {
            closeMobileMenu();
          } else {
            openMobileMenu();
          }
        });
      }

      // Close button in mobile menu
      if (navCloseBtn) {
        navCloseBtn.addEventListener('click', closeMobileMenu);
      }

      // Function to open a submenu
      const openSubmenu = (item) => {
        const submenu = item.querySelector(':scope > ul');
        const link = item.querySelector(':scope > a');
        if (link) link.setAttribute('aria-expanded', 'true');
        if (submenu) {
          submenu.classList.add('submenu-open');
        }
      };

      // Function to close a submenu
      const closeSubmenu = (item) => {
        const submenu = item.querySelector(':scope > ul');
        const link = item.querySelector(':scope > a');
        if (link) link.setAttribute('aria-expanded', 'false');
        if (submenu) {
          submenu.classList.remove('submenu-open');
        }
      };

      // Function to close sibling submenus
      const closeSiblingSubmenus = (item) => {
        const parentList = item.parentElement;
        const siblingItems = parentList.querySelectorAll(':scope > .has-submenu');

        siblingItems.forEach((sibling) => {
          if (sibling !== item) {
            closeSubmenu(sibling);
          }
        });
      };

      // Submenu toggles (mobile) - Click handler
      submenuItems.forEach((item) => {
        const link = item.querySelector(':scope > a');
        if (!link) return;

        link.addEventListener('click', (e) => {
          // Only handle on mobile
          if (window.innerWidth >= 990) return;
          
          e.preventDefault();
          const isExpanded = link.getAttribute('aria-expanded') === 'true';

          // Close other submenus at the same level
          closeSiblingSubmenus(item);

          // Toggle current submenu
          if (isExpanded) {
            closeSubmenu(item);
          } else {
            openSubmenu(item);
          }
        });

        // Keyboard navigation - Focus handler for mobile menu
        link.addEventListener('focus', () => {
          if (window.innerWidth < 990) {
            // Close sibling submenus
            closeSiblingSubmenus(item);
            // Open current submenu
            openSubmenu(item);
          }
        });
      });

      // Close submenu when focus leaves the entire submenu branch
      const navItems = widgetElement.querySelectorAll('.nav-item');
      navItems.forEach((item) => {
        item.addEventListener('focusout', (e) => {
          if (window.innerWidth < 990) {
            // Check if the new focus target is outside this nav item
            setTimeout(() => {
              if (!item.contains(document.activeElement)) {
                if (item.classList.contains('has-submenu')) {
                  closeSubmenu(item);
                }
              }
            }, 0);
          }
        });
      });

      // Keyboard navigation
      widgetElement.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // Close mobile menu
          if (headerNav.classList.contains('nav-open')) {
            closeMobileMenu();
            menuToggle.focus();
          }

          // Close open submenus
          submenuItems.forEach((item) => {
            const submenu = item.querySelector(':scope > ul');
            if (submenu && submenu.classList.contains('submenu-open')) {
              closeSubmenu(item);
              const link = item.querySelector(':scope > a');
              if (link) link.focus();
            }
          });
        }
      });

      // Close mobile menu when clicking outside (on desktop breakpoint)
      document.addEventListener('click', (e) => {
        if (window.innerWidth >= 990) return;

        if (!widgetElement.contains(e.target) && headerNav.classList.contains('nav-open')) {
          closeMobileMenu();
        }
      });

      // Handle window resize
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 990) {
          // Reset mobile menu state on desktop
          closeMobileMenu();

          // Reset submenu states
          submenuItems.forEach((item) => {
            closeSubmenu(item);
          });
        }
      });
    });
  </script>
</header>
