<section
  id="{{ widget.id }}"
  class="widget widget-type-timeline widget-{{ widget.id }} color-scheme-{{ widget.settings.color_scheme }} {% if widget.settings.layout == 'horizontal' %}layout-horizontal{% elsif widget.settings.layout == 'centered' %}layout-centered{% endif %}"
  {% if widget.settings.color_scheme == 'dark' %}
    style="--widget-bg-color: var(--bg-primary);"
  {% endif %}
  data-widget-id="{{ widget.id }}"
  data-widget-type="timeline"
  {% if widget.index != null %}data-widget-index="{{ widget.index }}"{% endif %}
>
  <style>
    .widget-{{ widget.id }} {
      & .timeline-list {
        list-style: none;
        padding: 0;
        margin: 0;
        position: relative;
      }

      & .timeline-item {
        position: relative;
        padding-inline-start: 4rem;
        padding-block-end: var(--space-3xl);

        &:last-child {
          padding-block-end: 0;
        }

        &::before {
          content: "";
          position: absolute;
          inset-inline-start: 1.4375rem;
          inset-block-start: 3.5rem;
          inset-block-end: 0;
          width: var(--border-width-medium);
          background-color: var(--border-color);
        }

        &:last-child::before {
          display: none;
        }
      }

      & .timeline-marker {
        position: absolute;
        inset-inline-start: 0;
        inset-block-start: 0;
        width: 3rem;
        height: 3rem;
        background-color: var(--text-heading);
        border: 0.3rem solid var(--bg-primary);
        box-shadow: 0 0 0 var(--border-width-medium) var(--text-heading);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
      }

      & .marker-number {
        color: var(--bg-primary);
      }

      & .timeline-content {
        background-color: var(--bg-secondary);
        padding: var(--space-lg);
        border-inline-start: 0.3rem solid var(--text-heading);
      }

      & .timeline-meta {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-block-end: var(--space-sm);
        flex-wrap: wrap;
      }

      & .timeline-duration {
        padding-inline-start: var(--space-sm);
        border-inline-start: var(--border-width-thin) solid var(--border-color);
      }

      & .timeline-title {
        margin-block-end: var(--space-sm);
      }

      & .timeline-text {
        margin-block-end: var(--space-md);

        &:last-child {
          margin-block-end: 0;
        }
      }

      @media (min-width: 750px) {
        & .timeline-item {
          padding-inline-start: 5rem;
        }

        & .timeline-marker {
          width: 3.5rem;
          height: 3.5rem;
        }


        & .timeline-item::before {
          inset-inline-start: 1.6875rem;
        }

        & .timeline-content {
          padding: var(--space-xl);
        }

      }

      /* Layout: Horizontal */
      &.layout-horizontal {
        @media (min-width: 990px) {
          & .timeline-list {
            display: flex;
            gap: 0;
            position: relative;
            padding-block-start: 0;

            &::before {
              content: "";
              position: absolute;
              inset-inline-start: 2rem;
              inset-inline-end: 2rem;
              inset-block-start: 1.75rem;
              height: var(--border-width-medium);
              background-color: var(--border-color);
              z-index: 0;
            }
          }

          & .timeline-item {
            flex: 1;
            padding-inline-start: 0;
            padding-block-end: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;

            &::before {
              display: none;
            }
          }

          & .timeline-marker {
            position: relative;
            inset-inline-start: 0;
            inset-block-start: 0;
            margin-block-end: var(--space-lg);
            z-index: 1;
          }

          & .timeline-content {
            flex: 1;
            border-inline-start: none;
            background-color: transparent;
            padding: 0;
          }

          & .timeline-meta {
            justify-content: center;
          }

          & .features-list {
            text-align: start;
          }
        }

        @media (min-width: 1200px) {
        }
      }

      /* Layout: Centered (alternating sides) */
      &.layout-centered {

        @media (min-width: 990px) {
          & .timeline-list {
            position: relative;

            &::before {
              content: "";
              position: absolute;
              inset-inline-start: 50%;
              inset-block-start: 0;
              inset-block-end: 0;
              width: var(--border-width-medium);
              background-color: var(--border-color);
              transform: translateX(-50%);
            }
          }

          & .timeline-item {
            padding-inline-start: 0;
            padding-inline-end: 0;
            width: 50%;
            padding-block-end: var(--space-4xl);

            &:nth-child(odd) {
              margin-inline-start: 0;
              margin-inline-end: auto;
              padding-inline-end: var(--space-3xl);

              & .timeline-marker {
                inset-inline-start: auto;
                inset-inline-end: -1.75rem;
              }

              & .timeline-content {
                border-inline-start: none;
                border-inline-end: 0.3rem solid var(--text-heading);
              }
            }

            &:nth-child(even) {
              margin-inline-start: auto;
              margin-inline-end: 0;
              padding-inline-start: var(--space-3xl);

              & .timeline-marker {
                inset-inline-start: -1.75rem;
              }
            }

            &::before {
              display: none;
            }
          }

          & .timeline-item:last-child::before {
            display: none;
          }
        }
      }
    }
  </style>

  <div class="widget-container {% if widget.settings.color_scheme == 'dark' %}widget-container-padded{% endif %}">
    {% if widget.settings.title != blank or widget.settings.description != blank or widget.settings.eyebrow != blank %}
      <div class="widget-header">
        {% if widget.settings.eyebrow != blank %}
          <span class="widget-eyebrow" data-setting="eyebrow">{{ widget.settings.eyebrow }}</span>
        {% endif %}
        {% if widget.settings.title != blank %}
          {% if widget.index == 1 %}
            <h1 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h1>
          {% else %}
            <h2 class="widget-headline" data-setting="title">{{ widget.settings.title }}</h2>
          {% endif %}
        {% endif %}
        {% if widget.settings.description != blank %}
          <p class="widget-description" data-setting="description">{{ widget.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="widget-content {% if widget.settings.layout == 'centered' %}widget-content-lg{% endif %}">
      <ul class="timeline-list">
        {% assign item_index = 0 %}
        {% for blockId in widget.blocksOrder %}
          {% assign block = widget.blocks[blockId] %}
          {% assign item_index = item_index | plus: 1 %}
          <li class="timeline-item" data-block-id="{{ blockId }}">
            <div class="timeline-marker">
              <span class="marker-number block-text block-text-base">{{ item_index }}</span>
            </div>

            <div class="timeline-content">
              {% if block.settings.date != blank or block.settings.duration != blank %}
                <div class="timeline-meta">
                  {% if block.settings.date != blank %}
                    <span class="timeline-date block-text block-text-sm block-text-semibold block-text-uppercase block-text-accent" data-setting="date">{{ block.settings.date }}</span>
                  {% endif %}
                  {% if block.settings.duration != blank %}
                    <span class="timeline-duration block-text block-text-sm block-text-muted" data-setting="duration">{{ block.settings.duration }}</span>
                  {% endif %}
                </div>
              {% endif %}

              {% if block.settings.title != blank %}
                {% assign item_heading_level = 'h3' %}
                {% if widget.settings.title == blank %}
                  {% assign item_heading_level = 'h2' %}
                {% endif %}
                <{{ item_heading_level }} class="timeline-title block-text block-text-xl block-text-heading-weight block-text-heading" data-setting="title">{{ block.settings.title }}</{{ item_heading_level }}>
              {% endif %}

              {% if block.settings.description != blank %}
                <p class="timeline-text block-text block-text-sm block-text-muted" data-setting="description">{{ block.settings.description }}</p>
              {% endif %}

              {% if block.settings.features != blank %}
                <ul class="features-list" data-block-id="{{ blockId }}">
                  {% assign normalized_features = block.settings.features | replace: '\r\n', '\n' %}
                  {% assign features_list = normalized_features | split: '\n' %}
                  {% for feature in features_list %}
                    {% assign trimmed_feature = feature | strip %}
                    {% if trimmed_feature != blank %}
                      {% assign feature_text = trimmed_feature %}
                      {% assign icon_name = '' %}
                      {% assign first_char = trimmed_feature | slice: 0, 1 %}
                      {% if first_char == '+' %}
                        {% assign icon_name = 'check' %}
                        {% assign feature_text = trimmed_feature | remove_first: '+' | strip %}
                      {% elsif first_char == '-' %}
                        {% assign icon_name = 'x' %}
                        {% assign feature_text = trimmed_feature | remove_first: '-' | strip %}
                      {% endif %}
                      <li class="feature-item block-text">
                        {% if icon_name != blank %}
                          <span class="feature-icon">
                            {% render 'icon', icon: icon_name, class: 'feature-icon-svg' %}
                          </span>
                        {% endif %}
                        <span>{{ feature_text }}</span>
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</section>
